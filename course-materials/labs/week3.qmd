---
title: "Lab 3: Difference-in-Difference"
author: "Annie Adams"
date: "`r Sys.Date()`"
format: html
execute:
  execute-dir: project
---

## Objective:

Use the Difference-in-Differences (DiD) framework to estimate the impact of COVID-19 lockdowns on air pollution ($NO_2$).

## DiD # 1: Los Angeles, CA vs Phoenix, AZ

In this scenario, we compare two major Southwestern hubs that faced very different lockdown mandates in March 2019: Los Angeles, CA and Phoenix, AZ. 

On March 19th, 2020, California Governor Gavin Newsom issued a Statewide shelter in place order. Phoenix, AZ did not start their lockdown until March 31, 2020. The strictness of the lockdown varied from city to city. In Arizona, hair salons and golf courses were allowed to stay open ( https://www.nbcnews.com/news/us-news/arizona-mayors-slam-covid-19-stay-home-order-allows-hair-n1174186), while Los Angeles had a stricter lockdown order that did not permit such businesses to operate.   

- Outcome ($Y$): Nitrogen Dioxide ($NO_2$), which is primarily produced by vehicle traffic
- Treatment Group: Los Angeles (Early, strict lockdown)
- Control Group: Phoenix (Later, shorter lockdown)


```{r}
library(tidyverse)
library(janitor)
```


#### Read in LA and Phoenix EPA Data

```{r}
LA_2019 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "LA_2019.csv")) %>% filter(`Local Site Name` == "West Los Angeles") %>% mutate(city = "LA", year = 2019)

LA_2020 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "LA_2020.csv")) %>% filter(`Local Site Name` == "West Los Angeles") %>% mutate(city = "LA", year = 2020)

Phoenix_2019 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "phoenix_2019.csv")) %>% filter(`Local Site Name` == "WEST PHOENIX") %>% 
  mutate(city = "Phoenix", year = 2019)

Phoenix_2020 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "phoenix_2020.csv")) %>% filter(`Local Site Name` == "WEST PHOENIX") %>% 
mutate(city = "Phoenix", year = 2020)

# Combine all into one master data frame
did_data_az_ca <- bind_rows(LA_2019, LA_2020, Phoenix_2019, Phoenix_2020) %>% clean_names()

```

### Parallel Trends

A DiD is only valid if the Treatment and Control groups were moving in the same direction before the policy hit. Let's see if we pass the parallel trends assumption here. 

```{r}
weekly_la_phx <- did_data_az_ca %>%
  mutate(
    date_obj = mdy(date),
    week = floor_date(date_obj, unit = "week")
  ) %>%
  filter(year == 2020, month(date_obj) %in% c(2, 3, 4)) %>%
  group_by(week, city) %>%
  summarize(
    mean_no2 = mean(daily_max_1_hour_no2_concentration, na.rm = TRUE), 
    .groups = "drop"
  )

# Create line plot of phx and LA
ggplot(weekly_la_phx, aes(x = week, y = mean_no2, color = city)) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  
  # Add CA lockdown start date dashed line
  geom_vline(xintercept = as.Date("2020-03-19"), linetype = "dashed", color = "gray30", size = 1) +

  # Add CA lockdown start date label
  annotate("label", x = as.Date("2020-03-20"), y = 30, 
           label = "CA Lockdown \n Starts", hjust = 0, size = 3) +
           
  labs(
    title = "Weekly NO2 Trends: Los Angeles vs. Phoenix",
    x = "Date",
    y = "Weekly Avg NO2 (ppb)",
    color = "City"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")
```


:::{.callout-tip}

Look at the lines before the dashed vertical line. Are they moving together? If Phoenix is rising while LA is falling (or vice versa) before the lockdown, can we truly blame the lockdown for the difference we see afterward?
:::


### Difference in Difference Model

We need to create dummy variables that we will use in our model! Specifically, we want to specify the treatment and time period for each observation. 



```{r}
did_data_az_ca <- did_data_az_ca %>%
  mutate(
    date_obj = mdy(date),
    #treatment = NM, control = TX
    treated = ifelse(city == "LA", 1, 0),

    # Post = after Mar 23
    is_post = ifelse(date_obj >= as.Date("2020-03-23"), 1, 0)
  )
```

### Estimating the treatment effect 

The simplest form of estimating the treatment effect can be denoted by : 

$(Y_{\text{treat, post}} - Y_{\text{treat, pre}}) - (Y_{\text{control, post}} - Y_{\text{control, pre}})$

Another way to estimate DiD (and the way we will often use in this course), is to use regression. 

$$y = \beta_0 + \beta_1 \cdot \text{treat} + \beta_2 \cdot \text{year} + \beta_3 \cdot (\text{treat} \times \text{year})$$

Let's start by manually calculating the treatment effect using the first formula. 

```{r}
y_trt_post <- did_data_az_ca %>% filter(treated == 1, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

y_trt_pre <- did_data_az_ca %>% filter(treated == 1, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

y_con_post <- did_data_az_ca %>% filter(treated == 0, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

y_con_pre <- did_data_az_ca %>% filter(treated == 0, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

trt_effect <- (y_trt_post- y_trt_pre) - (y_con_post - y_con_pre)

print(paste("The treatment effect is", round(trt_effect,4)))
```


```{r}
la_phx_did <- lm(daily_max_1_hour_no2_concentration ~ treated + is_post + treated:is_post, 
                 data = filter(did_data_az_ca, year == 2020))

summary(la_phx_did)
```


## DiD # 2: Dona Ana County, NM and El Paso County, TX

This DiD is for Dona Ana County in New Mexico and El Paso County in Texas. These are bordering counties that had two different lockdown scenarios. 

- Outcome ($Y$): Nitrogen Dioxide ($NO_2$), which is primarily produced by vehicle traffic
- Treatment Group: Dona Ana County, NM (Early, strict lockdown)
- Control Group: El Paso County, TX (Later, shorter lockdown)




```{r}
NM_2019 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "nm_2019.csv")) %>%  mutate(state = "NM", year = 2019, 
      `County FIPS Code`  = as.numeric(`County FIPS Code`))                                                                                   

NM_2020 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "nm_2020.csv")) %>%  mutate(state = "NM", year = 2020,                       `County FIPS Code`  = as.numeric(`County FIPS Code`))

TX_2019 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "tx_2019.csv")) %>% 
  mutate(state = "TX", year = 2019)

TX_2020 <- read_csv(here::here("course-materials", "labs", "data", "DiD", "tx_2020.csv")) %>% 
  mutate(state = "TX", year = 2020)


# Combine all into one master data frame
did_data_nm_tx <- bind_rows(NM_2019, NM_2020, TX_2019, TX_2020) %>% clean_names()
```


```{r}
did_weekly <- did_data_nm_tx %>%
  mutate(
    date_obj = mdy(date),
    week = floor_date(date_obj, unit = "week")
  ) %>%

  filter(year == 2020, month(date_obj) %in% c(2, 3, 4)) %>%
  group_by(week, state) %>%
  summarize(
    mean_no2 = mean(daily_max_1_hour_no2_concentration, na.rm = TRUE), 
    .groups = "drop"
  )

ggplot(did_weekly, aes(x = week, y = mean_no2, color = state)) +

  geom_line(size = 1.2) +

  geom_point(size = 3) +
  
  # Vertical line for the NM Lockdown (March 23, 2020)
  geom_vline(xintercept = as.Date("2020-03-23"), linetype = "dashed", color = "gray30", size = 1) +
  annotate("label", x = as.Date("2020-03-24"), y = 35, label = "NM Lockdown Starts", hjust = 0, size = 2.5) +
  labs(
    title = "Weekly 2020 NO2 Trends: NM vs TX",
    x = "Date",
    y = "Weekly Avg NO2 (ppb)",
    color = "State"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")

```

:::{callout-tip}
Notice how much more "in sync" these two lines are compared to LA and Phoenix. Why is a border comparison (same weather, same air) usually considered "cleaner" than comparing two distant cities?
:::


```{r}
did_data_nm_tx <- did_data_nm_tx %>%
  mutate(
    date_obj = mdy(date),
    #treatment = NM, control = TX
    treated = ifelse(state == "New Mexico", 1, 0),

    # Post = after Mar 23
    is_post = ifelse(date_obj >= as.Date("2020-03-23"), 1, 0)
  )
```

### Estimating the treatment effect 

Just like we did above, we will estimate the treatment effect both manually and with a regression model. 

The manual way of estimating the treatment effect can be denoted by : 

$(Y_{\text{treat, post}} - Y_{\text{treat, pre}}) - (Y_{\text{control, post}} - Y_{\text{control, pre}})$



```{r}
y_trt_post <- did_data_nm_tx %>% filter(treated == 1, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

y_trt_pre <- did_data_nm_tx %>% filter(treated == 1, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

y_con_post <- did_data_nm_tx %>% filter(treated == 0, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

y_con_pre <- did_data_nm_tx %>% filter(treated == 0, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()

trt_effect <- (y_trt_post- y_trt_pre) - (y_con_post - y_con_pre)

print(paste("The treatment effect is", round(trt_effect,4)))
```

Now, lets use a regression to estimate our treatment effect!

$$y = \beta_0 + \beta_1 \cdot \text{treat} + \beta_2 \cdot \text{year} + \beta_3 \cdot (\text{treat} \times \text{year})$$


```{r}
tx_nm_did <- lm(daily_max_1_hour_no2_concentration ~ treated * is_post, 
                 data = filter(did_data_nm_tx, year == 2020))

summary(tx_nm_did)
```


```{r}
# Filter for 2019 only
placebo_data <- did_data %>%
  filter(year == 2019) %>%
  mutate(
    date_obj = mdy(Date),
    treated = ifelse(state == "NM", 1, 0),
    is_post = ifelse(date_obj >= as.Date("2019-03-23"), 1, 0)
  )

#  placebo regression
placebo_model <- lm(`Daily Max 1-hour NO2 Concentration` ~ treated * is_post, 
                    data = placebo_data)

summary(placebo_model)
```


```{r}
placebo_weekly <- placebo_data %>%
  mutate(week = floor_date(date_obj, unit = "week")) %>%
  filter(month(date_obj) %in% c(2, 3, 4)) %>%
  group_by(week, state) %>%
  summarize(mean_no2 = mean(`Daily Max 1-hour NO2 Concentration`, na.rm = TRUE), .groups = "drop")

ggplot(placebo_weekly, aes(x = week, y = mean_no2, color = state)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  geom_vline(xintercept = as.Date("2019-03-23"), linetype = "dashed", color = "gray30") +
  annotate("label", x = as.Date("2019-03-24"), y = 35, label = "Placebo Lockdown", size = 2.5) +
  labs(title = "Placebo Test: NM vs TX (2019)",
       subtitle = "Testing for Parallel Trends before COVID-19",
       y = "Weekly Avg NO2 (ppb)") +
  theme_minimal() +
  scale_color_brewer(palette = "Set1")
```

