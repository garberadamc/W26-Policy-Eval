{
  "hash": "ed690b7266e71651af6c9e770fcb7f2e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab 3: Difference-in-Difference\"\nsubtitle: \"COVID-19 Lockdowns and the Search for a Perfect Counterfactual\"\nauthor: \"Annie Adams\"\ndate: \"2026-01-23\"\nformat: html\nexecute:\n  execute-dir: project\n---\n\n## Objective:\n\nUse the Difference-in-Differences (DiD) framework to estimate the impact of COVID-19 lockdowns on air pollution ($NO_2$).\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Words on the Orpheum theater marquee try to bring levity to the current situation along the normally bustling commercial area on Broadway in downtown Los Angeles. Source: [LA Times](https://www.latimes.com/california/story/2020-03-27/coronavirus-spotlight-broadway-in-downtown-los-angeles)](images/LA_lockdown.png){#fig-lockdown fig-align='center' width=60%}\n:::\n:::\n\nIn March 2020, counties across the United States responded to the start of what would be the COVID 19 Pandemic. While every state faced the same biological threat, governors responded with vastly different mandates. Some states, like California and New Mexico, implemented strict \"Stay at Home\" orders early on. Others, like Arizona and Texas, opted for more relaxed restrictions, allowing businesses like golf courses and salons to remain open longer.In this lab, we will use a Difference-in-Difference (DiD) framework to isolate the impact of these varying lockdown levels. By comparing \"strict\" counties to their more \"relaxed\" neighbors, we can determine if the severity of the lockdown had a measurable impact on $NO_2$ levels— a key indicator of vehicle traffic and urban activity.\n\n## DiD # 1: Los Angeles, CA vs Phoenix, AZ\n\nIn this scenario, we compare two major Southwestern hubs that faced very different lockdown mandates in March 2019: Los Angeles, CA and Phoenix, AZ. \n\nOn March 19th, 2020, California Governor Gavin Newsom issued a Statewide shelter in place order. Phoenix, AZ did not start their lockdown until March 31, 2020. The strictness of the lockdown varied from city to city. In Arizona, [hair salons and golf courses were allowed to stay open]( https://www.nbcnews.com/news/us-news/arizona-mayors-slam-covid-19-stay-home-order-allows-hair-n117418), while Los Angeles had a [stricter lockdown](https://covid19.lacounty.gov/wp-content/uploads/HOO_Safer-at-Home-Order-for-Control-of-COVID_04102020.pdf) order that did not permit such businesses to operate.   \nWe will use these varying lockdown levels to see if the severity/ strictness of the lockdown had an impact on NO2 levels.  \n\n- Outcome ($Y$): Nitrogen Dioxide ($NO_2$), which is primarily produced by vehicle traffic\n- Treatment Group: Los Angeles (Early, strict lockdown)\n- Control Group: Phoenix (Later, shorter lockdown)\n\n> The Question: Can we use Phoenix as a \"mirror\" for what would have happened in LA without a lockdown?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(lubridate)\n```\n:::\n\n\n## About the Data\n\n### Data Source\n\nAir quality data for this analysis was obtained from the U.S. Environmental \nProtection Agency's (EPA) [Outdoor Air Quality Data](https://www.epa.gov/outdoor-air-quality-data/download-daily-data) \nportal. The dataset includes daily measurements of nitrogen dioxide (NO2) \nconcentrations from monitoring stations in Los Angeles, California and Phoenix, \nArizona.\n\n#### Read in LA and Phoenix EPA Data\n\n\n::: {.cell}\n\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nLA_2019 <- read_csv(here::here(\"week3\" ,\"data\",  \"LA_2019.csv\")) %>%\n  filter(`Local Site Name` == \"West Los Angeles\") %>% mutate(city = \"LA\", year = 2019)\n\n\nLA_2020 <- read_csv(here::here(\"week3\" ,\"data\", \"LA_2020.csv\")) %>% \n  filter(`Local Site Name` == \"West Los Angeles\") %>% mutate(city = \"LA\", year = 2020)\n\nPhoenix_2019 <- read_csv(here::here(\"week3\" ,\"data\", \"phoenix_2019.csv\")) %>% \n  filter(`Local Site Name` == \"WEST PHOENIX\") %>% \n  mutate(city = \"Phoenix\", year = 2019)\n\nPhoenix_2020 <- read_csv(here::here(\"week3\" ,\"data\", \"phoenix_2020.csv\")) %>% \n  filter(`Local Site Name` == \"WEST PHOENIX\") %>% \nmutate(city = \"Phoenix\", year = 2020)\n\n# Combine all into one master data frame\ndid_data_az_ca <- bind_rows(LA_2019, LA_2020, Phoenix_2019, Phoenix_2020) %>% clean_names()\n```\n:::\n\n\n\n\n### Parallel Trends\n\nA DiD is only valid if the Treatment and Control groups were moving in the same direction before the intervention hit. Let's see if we pass the parallel trends assumption. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nweekly_la_phx <- did_data_az_ca %>%\n  mutate(\n    date_obj = mdy(date),\n    week = floor_date(date_obj, unit = \"week\")\n  ) %>%\n  filter(year == 2020, month(date_obj) %in% c(2, 3, 4)) %>%\n  group_by(week, city) %>%\n  summarize(\n    mean_no2 = mean(daily_max_1_hour_no2_concentration, na.rm = TRUE), \n    .groups = \"drop\"\n  )\n\n# Create line plot of phx and LA\nggplot(weekly_la_phx, aes(x = week, y = mean_no2, color = city)) +\n  geom_line(size = 1.2) +\n  geom_point(size = 2.5) +\n  \n  # Add CA lockdown start date dashed line\n  geom_vline(xintercept = as.Date(\"2020-03-19\"), linetype = \"dashed\", color = \"gray30\", size = 1) +\n\n  # Add CA lockdown start date label\n  annotate(\"label\", x = as.Date(\"2020-03-20\"), y = 30, \n           label = \"CA Lockdown \\n Starts\", hjust = 0, size = 3) +\n           \n  labs(\n    title = \"Weekly NO2 Trends in 2020: Los Angeles vs. Phoenix\",\n    x = \"Date\",\n    y = \"Weekly Avg NO2 (ppb)\",\n    color = \"City\"\n  ) +\n  theme_minimal() +\n  scale_color_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n:::{.callout-tip}\n\nLook at the lines before the dashed vertical line. Are they moving together? If Phoenix is rising while LA is falling (or vice versa) before the lockdown, can we truly blame the lockdown for the difference we see afterward?\n:::\n\n<!--  PARALLEL TRENDS ASSUMPTION VIOLATED - don't continue\n### Difference in Difference Model\n\nWe need to create dummy variables that we will use in our model! Specifically, we want to specify the treatment and time period for each observation. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_data_az_ca <- did_data_az_ca %>%\n  mutate(\n    date_obj = mdy(date),\n    #treatment = NM, control = TX\n    treated = ifelse(city == \"LA\", 1, 0),\n\n    # Post = after Mar 23\n    is_post = ifelse(date_obj >= as.Date(\"2020-03-23\"), 1, 0)\n  )\n```\n:::\n\n\n### Estimating the treatment effect \n\nThe simplest form of estimating the treatment effect can be denoted by : \n\n$(Y_{\\text{treat, post}} - Y_{\\text{treat, pre}}) - (Y_{\\text{control, post}} - Y_{\\text{control, pre}})$\n\nAnother way to estimate DiD (and the way we will often use in this course), is to use regression. \n\n$$y = \\beta_0 + \\beta_1 \\cdot \\text{treat} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot (\\text{treat} \\times \\text{year})$$\n\nLet's start by manually calculating the treatment effect using the first formula. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ny_trt_post <- did_data_az_ca %>% filter(treated == 1, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_trt_pre <- did_data_az_ca %>% filter(treated == 1, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_post <- did_data_az_ca %>% filter(treated == 0, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_pre <- did_data_az_ca %>% filter(treated == 0, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ntrt_effect <- (y_trt_post- y_trt_pre) - (y_con_post - y_con_pre)\n\nprint(paste(\"The treatment effect is\", round(trt_effect,4)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"The treatment effect is -2.5226\"\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nla_phx_did <- lm(daily_max_1_hour_no2_concentration ~ treated + is_post + treated:is_post, \n                 data = filter(did_data_az_ca, year == 2020))\n\nsummary(la_phx_did)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = daily_max_1_hour_no2_concentration ~ treated + is_post + \n    treated:is_post, data = filter(did_data_az_ca, year == 2020))\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-22.150  -7.825  -0.519   6.850  50.084 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)       31.519      1.147  27.483  < 2e-16 ***\ntreated           -5.002      1.627  -3.075  0.00219 ** \nis_post           -3.368      1.306  -2.579  0.01010 *  \ntreated:is_post   -2.523      1.849  -1.364  0.17284    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 10.32 on 710 degrees of freedom\nMultiple R-squared:  0.1328,\tAdjusted R-squared:  0.1291 \nF-statistic: 36.23 on 3 and 710 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n-->\n\n\n## DiD # 2: Dona Ana County, NM and El Paso County, TX\n\nTo improve our study, we will look at two counties that share a border: Dona Ana County, NM (Treated) and El Paso County, TX (Control). Because they share the same desert air and weather patterns, El Paso is a much \"cleaner\" control group for Dona Ana.\n\n \n\n- Outcome ($Y$): Nitrogen Dioxide ($NO_2$), which is primarily produced by vehicle traffic\n- Treatment Group: Dona Ana County, NM (Early, strict lockdown)\n- Control Group: El Paso County, TX (Later, shorter lockdown)\n\n\nWe will start with reading in our New Mexico/ Texas data, and checking the parallel trends assumption for these two counties.\n\n<!-- FOR WEBSITE RENDERING --> \n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNM_2019 <- read_csv(here::here(\"week3\", \"data\", \"nm_2019.csv\")) %>% mutate(state = \"NM\", year = 2019, \n      `County FIPS Code`  = as.numeric(`County FIPS Code`))                                                                                   \n\nNM_2020 <- read_csv(here::here(\"week3\", \"data\", \"nm_2020.csv\")) %>%  mutate(state = \"NM\", year = 2020,                       `County FIPS Code`  = as.numeric(`County FIPS Code`))\n\nTX_2019 <- read_csv(here::here(\"week3\", \"data\", \"tx_2019.csv\")) %>% \n  mutate(state = \"TX\", year = 2019)\n\nTX_2020 <- read_csv(here::here(\"week3\", \"data\", \"tx_2020.csv\")) %>% \n  mutate(state = \"TX\", year = 2020)\n\n\n# Combine all into one master data frame\ndid_data_nm_tx <- bind_rows(NM_2019, NM_2020, TX_2019, TX_2020) %>% clean_names()\n```\n:::\n\n\n#### DiD # 2: Parallel Trends Assumption\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_weekly <- did_data_nm_tx %>%\n  mutate(\n    date_obj = mdy(date),\n    week = floor_date(date_obj, unit = \"week\")\n  ) %>%\n\n  filter(year == 2020, month(date_obj) %in% c(2, 3, 4)) %>%\n  group_by(week, state) %>%\n  summarize(\n    mean_no2 = mean(daily_max_1_hour_no2_concentration, na.rm = TRUE), \n    .groups = \"drop\"\n  )\n\nggplot(did_weekly, aes(x = week, y = mean_no2, color = state)) +\n\n  geom_line(size = 1.2) +\n\n  geom_point(size = 3) +\n  \n  # Vertical line for the NM Lockdown (March 23, 2020)\n  geom_vline(xintercept = as.Date(\"2020-03-23\"), linetype = \"dashed\", color = \"gray30\", size = 1) +\n  annotate(\"label\", x = as.Date(\"2020-03-24\"), y = 35, label = \"NM Lockdown Starts\", hjust = 0, size = 2.5) +\n  labs(\n    title = \"Weekly 2020 NO2 Trends: NM vs TX\",\n    x = \"Date\",\n    y = \"Weekly Avg NO2 (ppb)\",\n    color = \"State\"\n  ) +\n  theme_minimal() +\n  scale_color_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](week3_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n:::{callout-tip}\nNotice how much more \"in sync\" these two lines are compared to LA and Phoenix. Why is a border comparison (same weather, same air) usually considered \"cleaner\" than comparing two distant cities?\n:::\n\n### Getting ready for DiD\n\nIn order to include treatment and time as part of our DiD, we need to create dummy variables for them. We will create a variable `treated` that will be = 1 for New Mexico (the \"treated\" group in our scenario will be a stricter lockdown), and will be = 0 for Texas (the \"control\" group in our scenario will be the more relaxed lockdown.) \n\nOur `is_post` variable will denote weather or not the observation is after the intervention (in this case, the start of the lockdown in New Mexico.). `is_post` will = 0 for observations before March 23,2020, and will = 1 for observations after March 23, 2020. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_data_nm_tx <- did_data_nm_tx %>%\n  mutate(\n    date_obj = mdy(date),\n    #treatment = NM, control = TX\n    treated = ifelse(state == \"New Mexico\", 1, 0),\n\n    # Post = after Mar 23\n    is_post = ifelse(date_obj >= as.Date(\"2020-03-23\"), 1, 0)\n  )\n```\n:::\n\n\n### Estimating the treatment effect \n\nThe simplest form of estimating the treatment effect can be denoted by : \n\n$(Y_{\\text{treat, post}} - Y_{\\text{treat, pre}}) - (Y_{\\text{control, post}} - Y_{\\text{control, pre}})$\n\nAnother way to estimate DiD (and the way we will often use in this course), is to use regression. \n\n$$y = \\beta_0 + \\beta_1 \\cdot \\text{treat} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot (\\text{treat} \\times \\text{year})$$\n\nLet's start by manually calculating the treatment effect using the first formula. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ny_trt_post <- did_data_nm_tx %>% filter(treated == 1, is_post  == 1, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_trt_pre <- did_data_nm_tx %>% filter(treated == 1, is_post  == 0, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_post <- did_data_nm_tx %>% filter(treated == 0, is_post  == 1, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_pre <- did_data_nm_tx %>% filter(treated == 0, is_post  == 0, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ntrt_effect <- (y_trt_post- y_trt_pre) - (y_con_post - y_con_pre)\n\nprint(paste(\"The treatment effect is\", round(trt_effect,4)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"The treatment effect is 0.6052\"\n```\n\n\n:::\n:::\n\n\nNow, lets use a regression to estimate our treatment effect and see if we get a similar result!\n\n$$y = \\beta_0 + \\beta_1 \\cdot \\text{treat} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot (\\text{treat} \\times \\text{year})$$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntx_nm_did <- lm(daily_max_1_hour_no2_concentration ~ treated * is_post, \n                 data = filter(did_data_nm_tx, year == 2020))\n\nsummary(tx_nm_did)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = daily_max_1_hour_no2_concentration ~ treated * is_post, \n    data = filter(did_data_nm_tx, year == 2020))\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-27.165 -11.336  -1.815   8.484  48.735 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)      34.6480     1.5967  21.700  < 2e-16 ***\ntreated         -10.1542     2.2158  -4.583 5.48e-06 ***\nis_post          -4.5830     1.8320  -2.502   0.0126 *  \ntreated:is_post   0.6052     2.5292   0.239   0.8110    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 13.83 on 670 degrees of freedom\nMultiple R-squared:  0.1241,\tAdjusted R-squared:  0.1202 \nF-statistic: 31.65 on 3 and 670 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n\n:::{.callout-tip title=\"Comprehension Check\"}\nWhat does this treatment effect of .6052 mean? Talk with a partner! \n:::\n\n:::{.callout-warning}\n\nDoes our 2020 data tell the whole story? What if the drop we were experiencing in NO2 were due to seasonal trends, and were bound to happen with or without a lockdown? \n:::\n\n## Discussion Questions: \n\n1. Before the lockdown, we see week-to-week fluctuations in NO2 in New Mexico and Texas. Do you think that Texas make a compelling counterfactual which satisfies the main causal  identification assumption for DiD?\n\n2. Look at your summary(tx_nm_did) output. Which specific coefficient represents the \"Treatment Effect\" (the actual impact of the lockdown)?  Is this coefficient statistically significant at the 5% level ($p < 0.05$)? Explain what that $p$-value tells us about the relationship between the lockdown and $NO_2$.\n\n3. The DiD framework relies on a \"Counterfactual\"—the idea of what would have happened to New Mexico if it hadn't locked down. In this lab, what serves as our counterfactual?\nIf a massive dust storm hit both El Paso and Dona Ana on March 25th, would that ruin our DiD estimate? Why or why not? (Hint: Think about whether the storm affects both groups equally).\n\n4. Government mandates (lockdowns) are the \"Treatment,\" but the actual \"Cause\" of lower $NO_2$ is fewer cars on the road. If people in El Paso (the \"Control\" group) got scared and stayed home just as much as people in New Mexico (the \"Treated\" group) despite the lack of a legal mandate, what would happen to our DiD estimate? Would it get larger or smaller?\n",
    "supporting": [
      "week3_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}