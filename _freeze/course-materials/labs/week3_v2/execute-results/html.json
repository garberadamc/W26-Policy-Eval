{
  "hash": "cbb8ac0606890121204f2aa90e2b076d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab 3: Difference-in-Difference\"\nauthor: \"Annie Adams\"\ndate: \"2026-01-22\"\nformat: html\nexecute:\n  execute-dir: project\n---\n\n## Objective:\n\nUse the Difference-in-Differences (DiD) framework to estimate the impact of COVID-19 lockdowns on air pollution ($NO_2$).\n\n## DiD # 1: Los Angeles, CA vs Phoenix, AZ\n\nIn this scenario, we compare two major Southwestern hubs that faced very different lockdown mandates in March 2019: Los Angeles, CA and Phoenix, AZ. \n\nOn March 19th, 2020, California Governor Gavin Newsom issued a Statewide shelter in place order. Phoenix, AZ did not start their lockdown until March 31, 2020. The strictness of the lockdown varied from city to city. In Arizona, hair salons and golf courses were allowed to stay open ( https://www.nbcnews.com/news/us-news/arizona-mayors-slam-covid-19-stay-home-order-allows-hair-n1174186), while Los Angeles had a stricter lockdown order that did not permit such businesses to operate.   \n\n- Outcome ($Y$): Nitrogen Dioxide ($NO_2$), which is primarily produced by vehicle traffic\n- Treatment Group: Los Angeles (Early, strict lockdown)\n- Control Group: Phoenix (Later, shorter lockdown)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(janitor)\n```\n:::\n\n\n\n#### Read in LA and Phoenix EPA Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nLA_2019 <- read_csv(here::here(\"course-materials\", \"labs\", \"data\", \"DiD\", \"LA_2019.csv\")) %>%\n  filter(`Local Site Name` == \"West Los Angeles\") %>% mutate(city = \"LA\", year = 2019)\n\n\nLA_2020 <- read_csv(here::here(\"course-materials\", \"labs\", \"data\", \"DiD\", \"LA_2020.csv\")) %>% \n  filter(`Local Site Name` == \"West Los Angeles\") %>% mutate(city = \"LA\", year = 2020)\n\nPhoenix_2019 <- read_csv(here::here(\"course-materials\", \"labs\", \"data\", \"DiD\", \"phoenix_2019.csv\")) %>% \n  filter(`Local Site Name` == \"WEST PHOENIX\") %>% \n  mutate(city = \"Phoenix\", year = 2019)\n\nPhoenix_2020 <- read_csv(here::here(\"course-materials\", \"labs\", \"data\", \"DiD\", \"phoenix_2020.csv\")) %>% \n  filter(`Local Site Name` == \"WEST PHOENIX\") %>% \nmutate(city = \"Phoenix\", year = 2020)\n\n# Combine all into one master data frame\ndid_data_az_ca <- bind_rows(LA_2019, LA_2020, Phoenix_2019, Phoenix_2020) %>% clean_names()\n```\n:::\n\n\n### Parallel Trends\n\nA DiD is only valid if the Treatment and Control groups were moving in the same direction before the policy hit. Let's see if we pass the parallel trends assumption. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nweekly_la_phx <- did_data_az_ca %>%\n  mutate(\n    date_obj = mdy(date),\n    week = floor_date(date_obj, unit = \"week\")\n  ) %>%\n  filter(year == 2020, month(date_obj) %in% c(2, 3, 4)) %>%\n  group_by(week, city) %>%\n  summarize(\n    mean_no2 = mean(daily_max_1_hour_no2_concentration, na.rm = TRUE), \n    .groups = \"drop\"\n  )\n\n# Create line plot of phx and LA\nggplot(weekly_la_phx, aes(x = week, y = mean_no2, color = city)) +\n  geom_line(size = 1.2) +\n  geom_point(size = 2.5) +\n  \n  # Add CA lockdown start date dashed line\n  geom_vline(xintercept = as.Date(\"2020-03-19\"), linetype = \"dashed\", color = \"gray30\", size = 1) +\n\n  # Add CA lockdown start date label\n  annotate(\"label\", x = as.Date(\"2020-03-20\"), y = 30, \n           label = \"CA Lockdown \\n Starts\", hjust = 0, size = 3) +\n           \n  labs(\n    title = \"Weekly NO2 Trends in 2020: Los Angeles vs. Phoenix\",\n    x = \"Date\",\n    y = \"Weekly Avg NO2 (ppb)\",\n    color = \"City\"\n  ) +\n  theme_minimal() +\n  scale_color_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nâ„¹ Please use `linewidth` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](week3_v2_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n:::{.callout-tip}\n\nLook at the lines before the dashed vertical line. Are they moving together? If Phoenix is rising while LA is falling (or vice versa) before the lockdown, can we truly blame the lockdown for the difference we see afterward?\n:::\n\n<!--  PARALLEL TRENDS ASSUMPTION VIOLATED - dont continue\n### Difference in Difference Model\n\nWe need to create dummy variables that we will use in our model! Specifically, we want to specify the treatment and time period for each observation. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_data_az_ca <- did_data_az_ca %>%\n  mutate(\n    date_obj = mdy(date),\n    #treatment = NM, control = TX\n    treated = ifelse(city == \"LA\", 1, 0),\n\n    # Post = after Mar 23\n    is_post = ifelse(date_obj >= as.Date(\"2020-03-23\"), 1, 0)\n  )\n```\n:::\n\n\n### Estimating the treatment effect \n\nThe simplest form of estimating the treatment effect can be denoted by : \n\n$(Y_{\\text{treat, post}} - Y_{\\text{treat, pre}}) - (Y_{\\text{control, post}} - Y_{\\text{control, pre}})$\n\nAnother way to estimate DiD (and the way we will often use in this course), is to use regression. \n\n$$y = \\beta_0 + \\beta_1 \\cdot \\text{treat} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot (\\text{treat} \\times \\text{year})$$\n\nLet's start by manually calculating the treatment effect using the first formula. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ny_trt_post <- did_data_az_ca %>% filter(treated == 1, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_trt_pre <- did_data_az_ca %>% filter(treated == 1, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_post <- did_data_az_ca %>% filter(treated == 0, is_post  == 1, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_pre <- did_data_az_ca %>% filter(treated == 0, is_post  == 0, year == 2020) %>% summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ntrt_effect <- (y_trt_post- y_trt_pre) - (y_con_post - y_con_pre)\n\nprint(paste(\"The treatment effect is\", round(trt_effect,4)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"The treatment effect is -2.5226\"\n```\n\n\n:::\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nla_phx_did <- lm(daily_max_1_hour_no2_concentration ~ treated + is_post + treated:is_post, \n                 data = filter(did_data_az_ca, year == 2020))\n\nsummary(la_phx_did)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = daily_max_1_hour_no2_concentration ~ treated + is_post + \n    treated:is_post, data = filter(did_data_az_ca, year == 2020))\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-22.150  -7.825  -0.519   6.850  50.084 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)       31.519      1.147  27.483  < 2e-16 ***\ntreated           -5.002      1.627  -3.075  0.00219 ** \nis_post           -3.368      1.306  -2.579  0.01010 *  \ntreated:is_post   -2.523      1.849  -1.364  0.17284    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 10.32 on 710 degrees of freedom\nMultiple R-squared:  0.1328,\tAdjusted R-squared:  0.1291 \nF-statistic: 36.23 on 3 and 710 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n-->\n\nLet's move on to two other counties that may display more of a parallel trend. \n\n\n## DiD # 2: Dona Ana County, NM and El Paso County, TX\n\nThis DiD is for Dona Ana County in New Mexico and El Paso County in Texas. These are bordering counties that had two different lockdown scenarios. \n\n- Outcome ($Y$): Nitrogen Dioxide ($NO_2$), which is primarily produced by vehicle traffic\n- Treatment Group: Dona Ana County, NM (Early, strict lockdown)\n- Control Group: El Paso County, TX (Later, shorter lockdown)\n\n\nWe will start with reading in our New Mexico/ Texas data, and checking the parallel trends assumption for these two counties.\n\n<!-- FOR WEBSITE RENDERING --> \n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNM_2019 <- read_csv(here::here(\"week3\", \"data\", \"nm_2019.csv\")) %>% mutate(state = \"NM\", year = 2019, \n      `County FIPS Code`  = as.numeric(`County FIPS Code`))                                                                                   \n\nNM_2020 <- read_csv(here::here(\"week3\", \"data\", \"nm_2020.csv\")) %>%  mutate(state = \"NM\", year = 2020,                       `County FIPS Code`  = as.numeric(`County FIPS Code`))\n\nTX_2019 <- read_csv(here::here(\"week3\", \"data\", \"tx_2019.csv\")) %>% \n  mutate(state = \"TX\", year = 2019)\n\nTX_2020 <- read_csv(here::here(\"week3\", \"data\", \"tx_2020.csv\")) %>% \n  mutate(state = \"TX\", year = 2020)\n\n\n# Combine all into one master data frame\ndid_data_nm_tx <- bind_rows(NM_2019, NM_2020, TX_2019, TX_2020) %>% clean_names()\n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_weekly <- did_data_nm_tx %>%\n  mutate(\n    date_obj = mdy(date),\n    week = floor_date(date_obj, unit = \"week\")\n  ) %>%\n\n  filter(year == 2020, month(date_obj) %in% c(2, 3, 4)) %>%\n  group_by(week, state) %>%\n  summarize(\n    mean_no2 = mean(daily_max_1_hour_no2_concentration, na.rm = TRUE), \n    .groups = \"drop\"\n  )\n\nggplot(did_weekly, aes(x = week, y = mean_no2, color = state)) +\n\n  geom_line(size = 1.2) +\n\n  geom_point(size = 3) +\n  \n  # Vertical line for the NM Lockdown (March 23, 2020)\n  geom_vline(xintercept = as.Date(\"2020-03-23\"), linetype = \"dashed\", color = \"gray30\", size = 1) +\n  annotate(\"label\", x = as.Date(\"2020-03-24\"), y = 35, label = \"NM Lockdown Starts\", hjust = 0, size = 2.5) +\n  labs(\n    title = \"Weekly 2020 NO2 Trends: NM vs TX\",\n    x = \"Date\",\n    y = \"Weekly Avg NO2 (ppb)\",\n    color = \"State\"\n  ) +\n  theme_minimal() +\n  scale_color_brewer(palette = \"Set1\")\n```\n\n::: {.cell-output-display}\n![](week3_v2_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n:::{callout-tip}\nNotice how much more \"in sync\" these two lines are compared to LA and Phoenix. Why is a border comparison (same weather, same air) usually considered \"cleaner\" than comparing two distant cities?\n:::\n\n### Get ready for DiD\n\nIn order to include treatment and time as part of our DiD, we need to create dummy variables for them. We will create a variable `treated` that will be = 1 for New Mexico (the \"treated\" group in our scenario will be a stricter lockdown), and will be = 0 for Texas (the \"control\" group in our scenario will be the more relaxed lockdown.) \n\nOur `is_post` variable will denote weather or not the observation is after the intervention (in this case, the start of the lockdown in New Mexico.). `is_post` will = 0 for observations before March 23,2020, and will = 1 for observations after March 23, 2020. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndid_data_nm_tx <- did_data_nm_tx %>%\n  mutate(\n    date_obj = mdy(date),\n    #treatment = NM, control = TX\n    treated = ifelse(state == \"New Mexico\", 1, 0),\n\n    # Post = after Mar 23\n    is_post = ifelse(date_obj >= as.Date(\"2020-03-23\"), 1, 0)\n  )\n```\n:::\n\n\n### Estimating the treatment effect \n\nThe simplest form of estimating the treatment effect can be denoted by : \n\n$(Y_{\\text{treat, post}} - Y_{\\text{treat, pre}}) - (Y_{\\text{control, post}} - Y_{\\text{control, pre}})$\n\nAnother way to estimate DiD (and the way we will often use in this course), is to use regression. \n\n$$y = \\beta_0 + \\beta_1 \\cdot \\text{treat} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot (\\text{treat} \\times \\text{year})$$\n\nLet's start by manually calculating the treatment effect using the first formula. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ny_trt_post <- did_data_nm_tx %>% filter(treated == 1, is_post  == 1, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_trt_pre <- did_data_nm_tx %>% filter(treated == 1, is_post  == 0, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_post <- did_data_nm_tx %>% filter(treated == 0, is_post  == 1, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ny_con_pre <- did_data_nm_tx %>% filter(treated == 0, is_post  == 0, year == 2020) %>%\n  summarise(mean(daily_max_1_hour_no2_concentration)) %>% pull()\n\ntrt_effect <- (y_trt_post- y_trt_pre) - (y_con_post - y_con_pre)\n\nprint(paste(\"The treatment effect is\", round(trt_effect,4)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"The treatment effect is 0.6052\"\n```\n\n\n:::\n:::\n\n\nNow, lets use a regression to estimate our treatment effect and see if we get a similar result!\n\n$$y = \\beta_0 + \\beta_1 \\cdot \\text{treat} + \\beta_2 \\cdot \\text{year} + \\beta_3 \\cdot (\\text{treat} \\times \\text{year})$$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntx_nm_did <- lm(daily_max_1_hour_no2_concentration ~ treated * is_post, \n                 data = filter(did_data_nm_tx, year == 2020))\n\nsummary(tx_nm_did)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = daily_max_1_hour_no2_concentration ~ treated * is_post, \n    data = filter(did_data_nm_tx, year == 2020))\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-27.165 -11.336  -1.815   8.484  48.735 \n\nCoefficients:\n                Estimate Std. Error t value Pr(>|t|)    \n(Intercept)      34.6480     1.5967  21.700  < 2e-16 ***\ntreated         -10.1542     2.2158  -4.583 5.48e-06 ***\nis_post          -4.5830     1.8320  -2.502   0.0126 *  \ntreated:is_post   0.6052     2.5292   0.239   0.8110    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 13.83 on 670 degrees of freedom\nMultiple R-squared:  0.1241,\tAdjusted R-squared:  0.1202 \nF-statistic: 31.65 on 3 and 670 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n\n:::{callout-tip}\nWhat does this treatment effect of .6052 mean? Talk with a partner! \n:::\n\n\n\n",
    "supporting": [
      "week3_v2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}